name: Build Flutter iOS (Simulator + Release IPA)

on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build Flutter iOS
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable' # Latest stable для Dart 3.9.2+

      - name: Show Flutter version
        run: flutter --version

      - name: Clean and get dependencies
        run: |
          flutter clean
          flutter pub get

      - name: Create iOS platform and Podfile
        run: |
          if [ ! -d "ios" ] || [ ! -f "ios/Podfile" ]; then
            rm -rf ios
            flutter create --platforms=ios .
          fi
          # Ensure Podfile has platform 15.0
          if ! grep -q "platform :ios, '15.0'" ios/Podfile; then
            sed -i '' '/# Uncomment this line/i\\
          platform :ios, "15.0"\\
          ' ios/Podfile
          fi
          # Ensure post_install sets deployment target
          if ! grep -q "config.build_settings\['IPHONEOS_DEPLOYMENT_TARGET'\]" ios/Podfile; then
            echo '
          post_install do |installer|
            installer.pods_project.targets.each do |target|
              flutter_additional_ios_build_settings(target)
              target.build_configurations.each do |config|
                config.build_settings["IPHONEOS_DEPLOYMENT_TARGET"] = "15.0"
              end
            end
          end' >> ios/Podfile
          fi

      - name: Install CocoaPods
        run: |
          cd ios
          pod install --repo-update

      - name: Update iOS Deployment Target to 15.0 (post-pod)
        run: |
          # Агрессивный sed: Заменяем все варианты 13.0 на 15.0 (с пробелами/комментариями)
          find ios -name "project.pbxproj" -exec sed -i '' -E 's/(IPHONEOS_DEPLOYMENT_TARGET = )[0-9.]+;/\115.0;/g' {} \;
          # Проверяем все вхождения
          grep -n "IPHONEOS_DEPLOYMENT_TARGET" ios/Runner.xcodeproj/project.pbxproj || echo "No matches found - check file"

      - name: Build for Simulator (Debug)
        run: flutter build ios --simulator --debug --no-codesign

      - name: Upload Simulator App as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: flutter-ios-simulator-app
          path: build/ios/iphonesimulator/Runner.app # Уточнил path (iphonesimulator, не Debug-...)
          retention-days: 7

      - name: Build Unsigned Release Archive (no certificate needed)
        env:
          IOS_CERTIFICATE: ${{ secrets.IOS_CERTIFICATE }}
        run: |
          # Проверяем наличие cert в shell
          if [ -z "$IOS_CERTIFICATE" ]; then
            echo "No certificate found, building unsigned .xcarchive"
            flutter build ipa --release --no-codesign  # Создаёт .xcarchive в build/ios/archive/
            # Debug: Полный ls
            pwd
            ls -la build/
            ls -la build/ios/
            ls -la build/ios/archive/
            # Проверяем директорию (не файл!)
            ARCHIVE_PATH="$(pwd)/build/ios/archive/Runner.xcarchive"
            if [ -d "$ARCHIVE_PATH" ]; then  # Изменено: -d для dir
              echo "Archive directory created successfully at $ARCHIVE_PATH"
              du -sh "$ARCHIVE_PATH"  # Покажем размер
            else
              echo "Archive directory not found at $ARCHIVE_PATH - check build errors above"
              exit 1
            fi
          else
            echo "Certificate found, skipping unsigned build"
          fi

      - name: Build Signed Release IPA (with certificate)
        env:
          IOS_CERTIFICATE: ${{ secrets.IOS_CERTIFICATE }}
          IOS_PROVISIONING_PROFILE: ${{ secrets.IOS_PROVISIONING_PROFILE }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # Проверяем наличие cert в shell
          if [ -z "$IOS_CERTIFICATE" ]; then
            echo "No certificate found, skipping signed build"
            exit 0
          fi
          # Импорт cert и profile
          echo "$IOS_CERTIFICATE" | base64 --decode > /tmp/cert.p12
          echo "$IOS_PROVISIONING_PROFILE" | base64 --decode > /tmp/profile.mobileprovision

          # Создай keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security import /tmp/cert.p12 -k build.keychain -P "$KEYCHAIN_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" build.keychain

          # Установи profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp /tmp/profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/

          # Билд IPA
          flutter build ipa --release --export-options-plist=ios/ExportOptions.plist
          # Debug: Проверим IPA
          pwd
          ls -la build/ios/ipa/

          # Очисти keychain
          security delete-keychain build.keychain

      - name: Upload Release Artifact as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: flutter-ios-release # Общий имя для .ipa или .xcarchive
          path: |
            build/ios/ipa/*.ipa
            build/ios/archive/*.xcarchive
          retention-days: 7
          if-no-files-found: error # Теперь ошибка, если ничего нет

      # Опционально: Авто-аплоад в TestFlight (с Fastlane, только если signed)
      - name: Upload to TestFlight (optional)
        if: ${{ github.ref == 'refs/heads/main' }}
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APP_SPECIFIC_PASSWORD: ${{ secrets.APP_SPECIFIC_PASSWORD }}
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.APP_SPECIFIC_PASSWORD }}
          IOS_CERTIFICATE: ${{ secrets.IOS_CERTIFICATE }}
        run: |
          # Проверяем наличие cert в shell
          if [ -z "$IOS_CERTIFICATE" ]; then
            echo "No certificate found, skipping TestFlight upload"
            exit 0
          fi
          gem install fastlane
          cd ios
          fastlane match appstore  # Требует match setup в репо
          fastlane deliver
